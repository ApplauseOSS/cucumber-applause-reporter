{"version":3,"file":"index.mjs","sources":["../src/reporter.ts"],"sourcesContent":["import { Formatter, IFormatterOptions } from '@cucumber/cucumber';\nimport { AutoApi, TestResultStatus } from 'applause-reporter-common';\nimport { EventEmitter } from 'events';\nimport {\n  Envelope,\n  Pickle,\n  PickleStep,\n  TestCase,\n  TestCaseFinished,\n  TestCaseStarted,\n  TestStep,\n  TestStepFinished,\n  TestStepResultStatus,\n} from '@cucumber/messages';\n\nexport default class CucumberAutoApiFormatter extends Formatter {\n  private autoApi: AutoApi;\n\n  // Custom Parameters\n  private productId: number;\n  private runName: string;\n\n  // Maps used to handle data lookup between events.\n  // Test Case Storage Handles Storing Information about a TestCase by the TestCaseId\n  private testCaseStorage: { [testCaseId: string]: TestCase } = {};\n  // Test Case Instance Map Maps a TestCaseInstance Id (Single Execution of a TestCase) to the TestCaseId\n  private testCaseInstanceMap: { [testCaseInstanceId: string]: string } = {};\n  // Test Instance ResultId Map Holds References to the TestResult creation promise\n  private testCaseInstanceResultIdMap: {\n    [testCaseInstanceId: string]: Promise<number>;\n  } = {};\n  // Pickle Map Holds Information about the Gherkin TestCase Information (The actual written out test case)\n  private pickleMap: { [pickleId: string]: Pickle } = {};\n  // TestResult Status Map keeps track of the status for a TestCaseInstance. If a step fails, the test case fails\n  private testResultStatusMap: {\n    [testCaseInstanceId: string]: [TestResultStatus, string | undefined];\n  } = {};\n\n  constructor(options: IFormatterOptions) {\n    super(options);\n\n    // Extract out any arguments and handle validation\n    const apiKey = <string>options.parsedArgvOptions['apiKey'];\n    const autoApiUrl = <string>options.parsedArgvOptions['autoApiUrl'];\n    this.runName = <string>options.parsedArgvOptions['runName'];\n    this.productId = <number>options.parsedArgvOptions['productId'];\n    if (apiKey == undefined || apiKey.length <= 0) {\n      throw new Error('Invalid Api Key');\n    } else if (this.runName == undefined || this.runName.length <= 0) {\n      throw new Error('Invalid Run Name: ' + this.runName);\n    } else if (this.productId < 0) {\n      throw new Error(`Invalid Product Id: ${this.productId}`);\n    } else if (autoApiUrl == undefined || autoApiUrl.length <= 0) {\n      throw new Error('Invalid URL: ' + autoApiUrl);\n    }\n\n    // Setup our Http Client\n    this.autoApi = new AutoApi({\n      clientConfig: {\n        apiKey,\n        baseUrl: autoApiUrl,\n      },\n      productId: this.productId,\n      groupingName: this.runName,\n    });\n\n    // Add in listener hooks\n    this.registerListeners(options.eventBroadcaster);\n  }\n\n  /**\n   * Registering an event listener to Cucumber's Messaging Api. Only one event will\n   * be contained in each envelope\n   *\n   * @param eventBroadcaster An Event Emitter\n   */\n  registerListeners(eventBroadcaster: EventEmitter): void {\n    eventBroadcaster.on('envelope', (envelope: Envelope) => {\n      if (envelope.testCase) {\n        this.onTestCasePrepared(envelope.testCase);\n      } else if (envelope.pickle) {\n        this.pickleMap[envelope.pickle.id] = envelope.pickle;\n      } else if (envelope.testCaseStarted) {\n        this.onTestCaseStarted(envelope.testCaseStarted);\n      } else if (envelope.testStepFinished) {\n        this.onTestStepFinished(envelope.testStepFinished);\n      } else if (envelope.testCaseFinished) {\n        void this.onTestCaseFinished(envelope.testCaseFinished);\n      }\n    });\n  }\n\n  /**\n   * Hook called when a test case is parsed. Used for storing information about a TestCase\n   *\n   * @param event The Test Case Event\n   */\n  onTestCasePrepared(event: TestCase): void {\n    this.testCaseStorage[event.id] = event;\n  }\n\n  /**\n   * Hook called when a single instance of a test case is started. Used to register the start of a TestCase\n   *\n   * @param event The Test Case Started Event\n   */\n  onTestCaseStarted(event: TestCaseStarted): void {\n    this.testCaseInstanceMap[event.id] = event.testCaseId;\n    const testCase = this.testCaseStorage[event.testCaseId];\n    // These messages happen async from the execution of the test cases. That means that we need\n    this.testCaseInstanceResultIdMap[event.id] = this.autoApi\n      .startTestCase(this.pickleMap[testCase.pickleId].name)\n      .then(res => res.data.testResultId);\n    this.testResultStatusMap[event.id] = [TestResultStatus.PASSED, undefined];\n  }\n\n  /**\n   * Hook called when a TestStep is finished. Used to tell if and when a TestCase fails.\n   *\n   * @param event The Test Step Finished Event\n   */\n  onTestStepFinished(event: TestStepFinished): void {\n    // We already assume that the test case will pass, so if it did, just move on\n    if (event.testStepResult.status == TestStepResultStatus.PASSED) {\n      return;\n    }\n\n    const currentStatus = this.testResultStatusMap[event.testCaseStartedId][0];\n    // If the current result already has a status set, don't override it\n    if (currentStatus != TestResultStatus.PASSED) {\n      return;\n    }\n\n    // Get the test case ID\n    const testCaseId = this.testCaseInstanceMap[event.testCaseStartedId];\n\n    // Lookup the TestCase\n    const testCase = this.testCaseStorage[testCaseId];\n\n    // Look for the TestStep that was executed\n    const testStepOptions: TestStep[] = testCase.testSteps.filter(\n      s => s.id == event.testStepId\n    );\n    if (testStepOptions && testStepOptions.length != 1) {\n      throw new Error('Could not find test step within the test case');\n    }\n\n    // Now that we have the test step, lets look it up in the pickle to get the actual step text\n    const pickle: Pickle | undefined = this.pickleMap[testCase.pickleId];\n    const pickleStepId: string | undefined = testStepOptions[0].pickleStepId;\n    const pickleSteps: readonly PickleStep[] = pickle ? pickle.steps : [];\n    const pickleStep: PickleStep | undefined = pickleSteps.filter(\n      step => step.id == pickleStepId\n    )[0];\n\n    const stepText: string | undefined = pickleStep\n      ? pickleStep.text\n      : undefined;\n\n    // Map the step status to a result status\n    let status: TestResultStatus;\n    switch (event.testStepResult.status) {\n      case TestStepResultStatus.FAILED:\n        status = TestResultStatus.FAILED;\n        break;\n      case TestStepResultStatus.AMBIGUOUS:\n        status = TestResultStatus.ERROR;\n        break;\n      case TestStepResultStatus.PENDING:\n        status = TestResultStatus.ERROR;\n        break;\n      case TestStepResultStatus.SKIPPED:\n        status = TestResultStatus.SKIPPED;\n        break;\n      case TestStepResultStatus.UNDEFINED:\n        status = TestResultStatus.ERROR;\n        break;\n      case TestStepResultStatus.UNKNOWN:\n        status = TestResultStatus.FAILED;\n        break;\n    }\n\n    let errorMessage: string;\n    if (stepText != undefined) {\n      errorMessage = `${\n        event.testStepResult.status\n      } Test Step: ${stepText}. Reason: ${\n        event.testStepResult.message || 'Unknown'\n      }`;\n    } else {\n      errorMessage = `Test Case ${\n        event.testStepResult.status\n      } at Unknown Step. Reason: ${event.testStepResult.message || 'Unknown'}`;\n    }\n\n    // Finally, save off the updated statuses\n    this.testResultStatusMap[event.testCaseStartedId] = [status, errorMessage];\n  }\n\n  /**\n   * Hook called when a TestCase finishes it's execution. USed to submit test results to AutoApi\n   *\n   * @param event The TestCaseFinished event\n   */\n  async onTestCaseFinished(event: TestCaseFinished): Promise<void> {\n    // Wait for the test result to be created before starting the result submission\n    const resultId = await this.testCaseInstanceResultIdMap[\n      event.testCaseStartedId\n    ];\n    // Pull the TestResults from the TestResultStatusMap\n    const [status, failure] = this.testResultStatusMap[event.testCaseStartedId];\n\n    // Finally, submit the TestResult\n    void (await this.autoApi.submitTestResult(\n      resultId,\n      status || TestResultStatus.PASSED,\n      failure\n    ));\n  }\n}\n"],"names":[],"mappings":";;;;MAeqB,wBAAyB,SAAQ,SAAS;IAuB7D,YAAY,OAA0B;QACpC,KAAK,CAAC,OAAO,CAAC,CAAC;;;QAfT,oBAAe,GAAuC,EAAE,CAAC;;QAEzD,wBAAmB,GAA6C,EAAE,CAAC;;QAEnE,gCAA2B,GAE/B,EAAE,CAAC;;QAEC,cAAS,GAAmC,EAAE,CAAC;;QAE/C,wBAAmB,GAEvB,EAAE,CAAC;;QAML,MAAM,MAAM,GAAW,OAAO,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QAC3D,MAAM,UAAU,GAAW,OAAO,CAAC,iBAAiB,CAAC,YAAY,CAAC,CAAC;QACnE,IAAI,CAAC,OAAO,GAAW,OAAO,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAC;QAC5D,IAAI,CAAC,SAAS,GAAW,OAAO,CAAC,iBAAiB,CAAC,WAAW,CAAC,CAAC;QAChE,IAAI,MAAM,IAAI,SAAS,IAAI,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE;YAC7C,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC;SACpC;aAAM,IAAI,IAAI,CAAC,OAAO,IAAI,SAAS,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,IAAI,CAAC,EAAE;YAChE,MAAM,IAAI,KAAK,CAAC,oBAAoB,GAAG,IAAI,CAAC,OAAO,CAAC,CAAC;SACtD;aAAM,IAAI,IAAI,CAAC,SAAS,GAAG,CAAC,EAAE;YAC7B,MAAM,IAAI,KAAK,CAAC,uBAAuB,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC;SAC1D;aAAM,IAAI,UAAU,IAAI,SAAS,IAAI,UAAU,CAAC,MAAM,IAAI,CAAC,EAAE;YAC5D,MAAM,IAAI,KAAK,CAAC,eAAe,GAAG,UAAU,CAAC,CAAC;SAC/C;;QAGD,IAAI,CAAC,OAAO,GAAG,IAAI,OAAO,CAAC;YACzB,YAAY,EAAE;gBACZ,MAAM;gBACN,OAAO,EAAE,UAAU;aACpB;YACD,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,YAAY,EAAE,IAAI,CAAC,OAAO;SAC3B,CAAC,CAAC;;QAGH,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;KAClD;;;;;;;IAQD,iBAAiB,CAAC,gBAA8B;QAC9C,gBAAgB,CAAC,EAAE,CAAC,UAAU,EAAE,CAAC,QAAkB;YACjD,IAAI,QAAQ,CAAC,QAAQ,EAAE;gBACrB,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;aAC5C;iBAAM,IAAI,QAAQ,CAAC,MAAM,EAAE;gBAC1B,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,MAAM,CAAC;aACtD;iBAAM,IAAI,QAAQ,CAAC,eAAe,EAAE;gBACnC,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,eAAe,CAAC,CAAC;aAClD;iBAAM,IAAI,QAAQ,CAAC,gBAAgB,EAAE;gBACpC,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC;aACpD;iBAAM,IAAI,QAAQ,CAAC,gBAAgB,EAAE;gBACpC,KAAK,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC;aACzD;SACF,CAAC,CAAC;KACJ;;;;;;IAOD,kBAAkB,CAAC,KAAe;QAChC,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC;KACxC;;;;;;IAOD,iBAAiB,CAAC,KAAsB;QACtC,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,UAAU,CAAC;QACtD,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;;QAExD,IAAI,CAAC,2BAA2B,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,OAAO;aACtD,aAAa,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC;aACrD,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACtC,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,CAAC,gBAAgB,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;KAC3E;;;;;;IAOD,kBAAkB,CAAC,KAAuB;;QAExC,IAAI,KAAK,CAAC,cAAc,CAAC,MAAM,IAAI,oBAAoB,CAAC,MAAM,EAAE;YAC9D,OAAO;SACR;QAED,MAAM,aAAa,GAAG,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAC;;QAE3E,IAAI,aAAa,IAAI,gBAAgB,CAAC,MAAM,EAAE;YAC5C,OAAO;SACR;;QAGD,MAAM,UAAU,GAAG,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;;QAGrE,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,CAAC;;QAGlD,MAAM,eAAe,GAAe,QAAQ,CAAC,SAAS,CAAC,MAAM,CAC3D,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,KAAK,CAAC,UAAU,CAC9B,CAAC;QACF,IAAI,eAAe,IAAI,eAAe,CAAC,MAAM,IAAI,CAAC,EAAE;YAClD,MAAM,IAAI,KAAK,CAAC,+CAA+C,CAAC,CAAC;SAClE;;QAGD,MAAM,MAAM,GAAuB,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QACrE,MAAM,YAAY,GAAuB,eAAe,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC;QACzE,MAAM,WAAW,GAA0B,MAAM,GAAG,MAAM,CAAC,KAAK,GAAG,EAAE,CAAC;QACtE,MAAM,UAAU,GAA2B,WAAW,CAAC,MAAM,CAC3D,IAAI,IAAI,IAAI,CAAC,EAAE,IAAI,YAAY,CAChC,CAAC,CAAC,CAAC,CAAC;QAEL,MAAM,QAAQ,GAAuB,UAAU;cAC3C,UAAU,CAAC,IAAI;cACf,SAAS,CAAC;;QAGd,IAAI,MAAwB,CAAC;QAC7B,QAAQ,KAAK,CAAC,cAAc,CAAC,MAAM;YACjC,KAAK,oBAAoB,CAAC,MAAM;gBAC9B,MAAM,GAAG,gBAAgB,CAAC,MAAM,CAAC;gBACjC,MAAM;YACR,KAAK,oBAAoB,CAAC,SAAS;gBACjC,MAAM,GAAG,gBAAgB,CAAC,KAAK,CAAC;gBAChC,MAAM;YACR,KAAK,oBAAoB,CAAC,OAAO;gBAC/B,MAAM,GAAG,gBAAgB,CAAC,KAAK,CAAC;gBAChC,MAAM;YACR,KAAK,oBAAoB,CAAC,OAAO;gBAC/B,MAAM,GAAG,gBAAgB,CAAC,OAAO,CAAC;gBAClC,MAAM;YACR,KAAK,oBAAoB,CAAC,SAAS;gBACjC,MAAM,GAAG,gBAAgB,CAAC,KAAK,CAAC;gBAChC,MAAM;YACR,KAAK,oBAAoB,CAAC,OAAO;gBAC/B,MAAM,GAAG,gBAAgB,CAAC,MAAM,CAAC;gBACjC,MAAM;SACT;QAED,IAAI,YAAoB,CAAC;QACzB,IAAI,QAAQ,IAAI,SAAS,EAAE;YACzB,YAAY,GAAG,GACb,KAAK,CAAC,cAAc,CAAC,MACvB,eAAe,QAAQ,aACrB,KAAK,CAAC,cAAc,CAAC,OAAO,IAAI,SAClC,EAAE,CAAC;SACJ;aAAM;YACL,YAAY,GAAG,aACb,KAAK,CAAC,cAAc,CAAC,MACvB,6BAA6B,KAAK,CAAC,cAAc,CAAC,OAAO,IAAI,SAAS,EAAE,CAAC;SAC1E;;QAGD,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,iBAAiB,CAAC,GAAG,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC;KAC5E;;;;;;IAOD,MAAM,kBAAkB,CAAC,KAAuB;;QAE9C,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,2BAA2B,CACrD,KAAK,CAAC,iBAAiB,CACxB,CAAC;;QAEF,MAAM,CAAC,MAAM,EAAE,OAAO,CAAC,GAAG,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;;QAG5E,MAAM,MAAM,IAAI,CAAC,OAAO,CAAC,gBAAgB,CACvC,QAAQ,EACR,MAAM,IAAI,gBAAgB,CAAC,MAAM,EACjC,OAAO,CACR,CAAC,CAAC;KACJ;;;;;"}