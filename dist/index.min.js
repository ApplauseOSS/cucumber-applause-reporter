!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@cucumber/cucumber"),require("applause-reporter-common"),require("@cucumber/messages")):"function"==typeof define&&define.amd?define(["exports","@cucumber/cucumber","applause-reporter-common","@cucumber/messages"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["cucumber-applause-reporter"]={},e.cucumber,e.applauseReporterCommon,e.messages)}(this,(function(e,t,s,a){"use strict";const i="applause-session-id";class n extends t.Formatter{constructor(e){super(e),this.testCaseStorage={},this.testCaseInstanceMap={},this.testCaseInstanceSessionMap={},this.pickleMap={},this.testResultStatusMap={},this.REMOVE_CONTROL_CHARS=new RegExp(/[^\x00-\x7F]/gm),this.REMOVE_ANSI_CHARACTERS=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|"),"gm"),console.log("CDP is: "+process.cwd());const t=s.loadConfig({configFile:"applause.json",properties:{apiKey:e.parsedArgvOptions.apiKey,baseUrl:e.parsedArgvOptions.autoApiUrl,productId:e.parsedArgvOptions.productId,testRailOptions:e.parsedArgvOptions.testRailOptions,applauseTestCycleId:e.parsedArgvOptions.applauseTestCycleId}});this.reporter=new s.ApplauseReporter(t),this.registerListeners(e.eventBroadcaster)}registerListeners(e){e.on("envelope",(e=>{if(e.gherkinDocument&&e.gherkinDocument.feature?.children.map((e=>e.scenario?.name)),e.testRunStarted)this.reporter.runnerStart(Object.values(this.testCaseStorage).map((e=>this.pickleMap[e.pickleId].name)));else if(e.attachment){if(e.attachment.fileName==i){const t=e.attachment.testCaseStartedId;if(void 0===t)return;const s=this.testCaseInstanceSessionMap[t]||[];this.testCaseInstanceSessionMap[t]=[...s,e.attachment.body]}}else e.testCase?this.testCaseStorage[e.testCase.id]=e.testCase:e.pickle?this.pickleMap[e.pickle.id]=e.pickle:e.testCaseStarted?this.onTestCaseStarted(e.testCaseStarted):e.testStepFinished?this.onTestStepFinished(e.testStepFinished):e.testCaseFinished?this.onTestCaseFinished(e.testCaseFinished):e.testRunFinished&&this.reporter.runnerEnd()}))}onTestCaseStarted(e){this.testCaseInstanceMap[e.id]=e.testCaseId;const t=this.testCaseStorage[e.testCaseId];this.reporter.startTestCase(t.id,this.pickleMap[t.pickleId].name,{providerSessionIds:this.testCaseInstanceSessionMap[e.id]||[]}),this.testResultStatusMap[e.id]=[s.TestResultStatus.PASSED,void 0]}onTestStepFinished(e){if(e.testStepResult.status==a.TestStepResultStatus.PASSED)return;if(this.testResultStatusMap[e.testCaseStartedId][0]!=s.TestResultStatus.PASSED)return;const t=this.testCaseInstanceMap[e.testCaseStartedId],i=this.testCaseStorage[t],n=i.testSteps.filter((t=>t.id==e.testStepId));if(n&&1!=n.length)throw new Error("Could not find test step within the test case");const r=this.pickleMap[i.pickleId],p=n[0].pickleStepId,u=(r?r.steps:[]).filter((e=>e.id==p))[0],o=u?u.text:void 0;let c;switch(e.testStepResult.status){case a.TestStepResultStatus.FAILED:c=s.TestResultStatus.FAILED;break;case a.TestStepResultStatus.AMBIGUOUS:case a.TestStepResultStatus.PENDING:c=s.TestResultStatus.ERROR;break;case a.TestStepResultStatus.SKIPPED:c=s.TestResultStatus.SKIPPED;break;case a.TestStepResultStatus.UNDEFINED:c=s.TestResultStatus.ERROR;break;case a.TestStepResultStatus.UNKNOWN:c=s.TestResultStatus.FAILED}const d=this.cleanCucumberMessage(e.testStepResult.message||"Unknown");let l;l=null!=o?`${e.testStepResult.status} Test Step: ${o}. Reason: ${d}`:`Test Case ${e.testStepResult.status} at Unknown Step. Reason: ${d}`,this.testResultStatusMap[e.testCaseStartedId]=[c,l]}onTestCaseFinished(e){const[t,a]=this.testResultStatusMap[e.testCaseStartedId],i=this.testCaseInstanceMap[e.testCaseStartedId];this.reporter.submitTestCaseResult(i,t||s.TestResultStatus.PASSED,{failureReason:a,providerSessionGuids:this.testCaseInstanceSessionMap[e.testCaseStartedId]||[]})}cleanCucumberMessage(e){return e.replace(this.REMOVE_ANSI_CHARACTERS,"").replace(this.REMOVE_CONTROL_CHARS,"")}}e.APPLAUSE_SESSION_ID_ATTACHMENT=i,e.default=n,e.linkSessionId=function(e){this.attach(e,{fileName:i,mediaType:"text/plain"})},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.min.js.map
